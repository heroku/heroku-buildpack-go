#!/bin/sh
# usage: bin/compile <BUILD-dir> <CACHE-dir>

set -e

unset GIT_DIR # unset git dir or it will mess with goinstall

mkdir -p "$1" "$2"
BUILD=$(cd "$1/" && pwd)
CACHE=$(cd "$2/" && pwd)

PIP_DOWNLOAD_CACHE=$CACHE/pip
mkdir -p $PIP_DOWNLOAD_CACHE

GOVER=go1
GOTOOLCHAIN=go.$GOVER.linux-amd64.tar.gz
URL=http://go.googlecode.com/files/$GOTOOLCHAIN

if test -e $BUILD/bin && ! test -d $BUILD/bin
then
    echo >&2 '-----> ERROR: GOTOOLCHAIN bin exists and is not a directory.'
    exit 1
fi

echo "-----> Using Go $GOVER"

(
    set -e

    # Already cached?
    test -d $CACHE/go-$GOVER/go && exit

    rm -rf $CACHE/* # be sure not to BUILD up cruft
    mkdir -p $CACHE/go-$GOVER
    mkdir -p $CACHE/dependencies
    cd $CACHE/go-$GOVER
    echo "-----> Fetching Go $GOVER"
    curl -sO $URL
    tar zxf $GOTOOLCHAIN
    rm -f $GOTOOLCHAIN
)

GOROOT=$CACHE/go-$GOVER/go export GOROOT
GOPATH=$CACHE/dependencies:$BUILD export GOPATH
PATH=$BUILD/bin:$GOROOT/bin:$PATH

echo "-----> Installing hg"
pip install mercurial

echo "-----> Running go get and go install"
cd $BUILD
go get -fix ./...
