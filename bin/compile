#!/bin/sh
# usage: bin/compile <BUILD-dir> <CACHE-dir>

set -e

unset GIT_DIR # unset git dir or it will mess with goinstall


BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)

mkdir -p "$1" "$2"
BUILD=$(cd "$1/" && pwd)
CACHE=$(cd "$2/" && pwd)

VENV_LOC=$CACHE/venv
export PIP_DOWNLOAD_CACHE=$CACHE/pip
PYTHON_VERSION="2.7.2"
PYTHON_EXE="python2.7"
mkdir -p $PIP_DOWNLOAD_CACHE

GOVER=go1
GOTOOLCHAIN=go.$GOVER.linux-amd64.tar.gz
URL=http://go.googlecode.com/files/$GOTOOLCHAIN

export PATH=:/usr/local/bin:$PATH


if test -e $BUILD/bin && ! test -d $BUILD/bin
then
    echo >&2 '-----> ERROR: bin exists and is not a directory.'
    exit 1
fi

virtualenv() {
  python "$ROOT_DIR/vendor/virtualenv-1.7/virtualenv.py" "$@"
}

indent() {
  RE="s/^/       /"
  sed -u "$RE"
}


echo "-----> Using Go $GOVER"

(
    set -e

    # Already cached?
    test -d $CACHE/go-$GOVER/go && exit

    rm -rf $CACHE/* # be sure not to BUILD up cruft
    mkdir -p $CACHE/go-$GOVER
    mkdir -p $CACHE/dependencies
    cd $CACHE/go-$GOVER
    echo "-----> Fetching Go $GOVER"
    curl -sO $URL
    tar zxf $GOTOOLCHAIN
    rm -f $GOTOOLCHAIN
)

GOROOT=$CACHE/go-$GOVER/go export GOROOT
GOPATH=$CACHE/dependencies:$BUILD export GOPATH
PATH=$BUILD/bin:$GOROOT/bin:$PATH

echo "-----> Setting up python"
rm -rf $VENV_LOC/*
virtualenv --python $PYTHON_EXE --distribute --never-download --prompt='(venv) ' $VENV_LOC 2>&1 | indent
. $VENV_LOC/bin/activate
echo "-----> Setting up mercurial"
pip install --use-mirrors mercurial | indent

echo "-----> Running go get and go install"
cd $BUILD
go get -fix ./...
