name: Update Go Versions

on:
  schedule:
    - cron: '00 4 * * 1-5'
  workflow_dispatch:
    inputs:
      versions:
        description: 'Comma-separated list of Go versions to add (e.g., 1.24.12,1.25.6). Leave empty to auto-detect latest stable versions.'
        required: false
        type: string

# Disable all GITHUB_TOKEN permissions, since the GitHub App token is used instead.
permissions: {}

jobs:
  update-versions:
    name: Update Go versions
    runs-on: pub-hk-ubuntu-24.04-ip
    steps:
      - uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ vars.LINGUIST_GH_APP_ID }}
          private-key: ${{ secrets.LINGUIST_GH_PRIVATE_KEY }}

      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          # Using the GH application token here will configure the local git config for this repo with credentials
          # that can be used to make signed commits that are attributed to the GH application user
          token: ${{ steps.generate-token.outputs.token }}

      - name: Update Go versions
        id: update-versions
        run: ./sbin/update-go-versions "${{ inputs.versions }}"

      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ steps.generate-token.outputs.token }}
          title: ${{ inputs.versions && format('Add Go versions {0}', inputs.versions) || 'Add latest stable Go versions' }}
          commit-message: ${{ inputs.versions && format('Add Go versions {0}', inputs.versions) || 'Add latest stable Go versions' }}
          committer: ${{ vars.LINGUIST_GH_APP_USERNAME }} <${{ vars.LINGUIST_GH_APP_EMAIL }}>
          author: ${{ vars.LINGUIST_GH_APP_USERNAME }} <${{ vars.LINGUIST_GH_APP_EMAIL }}>
          branch: update-go-versions
          body: |
            ${{ inputs.versions && format('This PR adds support for the following Go versions: {0}', inputs.versions) || 'This PR adds support for the latest stable Go versions fetched from go.dev.' }}

      - name: Configure PR for auto-merge
        if: steps.pr.outputs.pull-request-operation == 'created'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: gh pr merge --squash --auto "${{ steps.pr.outputs.pull-request-number }}"
